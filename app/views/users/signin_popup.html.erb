
<div class="signin-popup">
  <%= form_for(@user, url: "/users", html: {id: "user_form"}) do |f| %>
    <h2>LOGIN OR REGISTER</h2>
    <div class="errors"></div>
    <div class="form-group">
      <label for="user_username">*Username</label>
      <input type="text" id="user_username" name="user[username]" class="form-control">
    </div>
    <div class="form-group">
      <input type="radio" id="is_login" name="login_or_register" checked="checked" value="login" class="login-or-register">
      <label for="is_login">Yes, I already have a new password</label>
    </div>
    <div class="form-group">
      <input type="radio" id="is_register" name="login_or_register" value="register" class="login-or-register">
      <label for="is_register">No, I am a new customer</label>
    </div>


    <div class="form-group for-register">
      <label for="user_first_name">*First Name</label>
      <input type="text" id="user_first_name" name="user[first_name]" class="form-control">
    </div>
    <div class="form-group for-register">
      <label for="user_last_name">*Last Name</label>
      <input type="text" id="user_last_name" name="user[last_name]" class="form-control">
    </div>
    <div class="form-group for-register">
      <label for="user_email">*Email</label>
      <input type="email" id="user_email" name="user[email]" class="form-control">
    </div>
    <div class="form-group">
      <label for="user_password_reg">*Password</label>
      <input type="password" id="user_password" name="user[password]" class="form-control">
    </div>
    <div class="form-group for-register">
      <label for="user_password_confirmation">*Password Confirmation</label>
      <input type="password" id="user_password_confirmation" name="user[password_reg]" class="form-control">
    </div>
    <div class="form-group for-register">
      <label for="user_country">*Country</label>
      <%= f.country_select :country, {priority: %w(US CA)}, class: "form-control" %>
    </div>

    <div class="form-group for-register">
      <label for="user_state">*State</label>
      <%= render partial: 'subregion_select', locals: {parent_region: f.object.country} %>
    </div>

    <div class="form-group for-register">
      <input type="checkbox" id="agree_terms" name="agree_terms" class="checkbox">
      <label for="agree_terms">I agree the <a href="#" class="green">Terms of Use</a> and the <a href="#" class="green">Privacy Policy</a></label>
    </div>

    <div class="form-group for-register">
      <input type="checkbox" id="agree_age" name="agree_age" class="checkbox">
      <label for="agree_age">I confirm that I am at least 18 years of age. Must be 19 years of age in Alabama and Nebraska.</label>
    </div>

    <div class="form-group">
      <input type="button" class="btn btn-default btn-login for-login" value="LOGIN">
      <input type="button" class="btn btn-default btn-register for-register" value="REGISTER">
      <input type="button" class="btn btn-default btn-cancel" data-dismiss="modal" value="CANCEL">
    </div>

    <div class="form-group for-login">
      <a href="#" class="green">Forgot your password?</a>
    </div>
  <% end %>

</div>

<script>

// this script shouldn't be put inline

"use strict";
/*globals $, console */

(function ($) {
  
  $("select#user_country").change(function () {
    var country_code, select_wrapper, url;
    select_wrapper = $("#user_state_wrapper");
    $("select", select_wrapper).attr("disabled", true);
    country_code = $(this).val();
    url = "/users/subregion_options?parent_region=" + country_code;
    select_wrapper.load(url);
  });

  //switching the screen login<->register
  $("input[name=\"login_or_register\"]").change(function (){
    if( $(this).val() == "login" ){
      $(".for-register").hide();
      $(".for-login").show();
    }else{
      $(".for-login").hide();
      $(".for-register").show();
    }
  });


  function toggleSpinner() {
    $(".ajax-loader").stop(true, true).fadeToggle("slow");
  }

  $(".btn-login").on("click", function () {
    var url = "/users/sign_in";
    $.ajax({
      type: "POST",
      url: url,
      data: $("#user_form").serialize(),
      beforeSend: function(){

        var errorContent = "";
        if($("#user_username").val() === ""){
          errorContent += "<div>Please enter username!</div>";
        }

        if($("#user_password").val() === ""){
          errorContent += "<div>Please enter password!</div>";
        }

        $(".errors").html(errorContent);
        if (errorContent !== ""){
          return false;
        } else {
          toggleSpinner();
        }
        
      },
      error: function () {
        toggleSpinner();
      },
      success: function(data) {
        // do not toggle the spinner on success
        console.log("login success");
        console.log(data);
        window.location.href = window.target_url;
      },
      statusCode: {
        404: function() {
          console.log("page not found" );
        },
        401: function(data){
          console.log(data);
          $(".errors").html("Invalid username or password!");
        }
      },
      dataType: "json"
    });
  });

  $(".btn-register").click(function (){
    var url = "/users";
    $.ajax({
      type: "POST",
      url: url,
      data: $("#user_form").serialize(),
      beforeSend: function(){

        var errorContent = "";
        var statesNot2Play = ["AZ", "IA", "MT", "LA", "WA"];

        function wrap(str) {
          return "<div>" + str + "</div>";
        }

        function assert(condition, msg) {
          if (condition) {
            errorContent += wrap(msg);
          }
        }

        var validate = {
          password: function (pw) {
            if (!pw || !pw.match(/^(?=.*[0-9])(?=.*[a-zA-Z])([a-zA-Z0-9]{6,15})$/)) {
              return false;
            }
            return true;
          }
        };

        assert(
          !$("#user_username").val(),
          "Please enter username!"
        );
        assert(
          !$("#user_first_name").val(),
          "Please enter first name!"
        );
        assert(
          !$("#user_last_name").val(),
           "Please enter last name!"
        );
        // isEmailAddress function is global
        // it could be moved into the validate object
        assert(
          !isEmailAddress($("#user_email").val()),
          "Please enter valid email!"
        );
        assert(
          !validate.password($("#user_password").val()),
          "Please enter valid password( 6 ~ 15 chars, at least one number )!"
        );
        assert(
          !$("#user_password_confirmation").val(),
          "Please enter password confirmation!"
        );
        assert(
          $("#user_password_confirmation").val() !== $("#user_password").val(),
          "Password confirmation does not match to password!"
        );
        assert(
          !$("#user_state").val(),
          "Please enter/select a state!"
        );
        assert(
          $("#user_country").val() === "US" &&
          $.inArray($("#user_state").val(), statesNot2Play) !== -1,
          "Does not allow to play in this state!</div>"
        );
        assert(
          !$("#agree_terms").is(":checked"),
          "You must agree to the Terms of Use and the Privacy Policy!"
        );
        assert(
          !$("#agree_age").is(":checked"),
          "You must agree to the Age and Location Policy!"
        );

        $(".errors").html(errorContent);

        if (errorContent.length > 0) {
          return false;
        } else {
          toggleSpinner();
        }
      },
      error: function () {
        toggleSpinner();
      },
      success: function(data){
        // do not toggle the spinner on success
        console.log("register success");
        console.log(data);
        window.location.href = window.target_url;
      },
      statusCode: {
        422: function(data){
          var res = $.parseJSON(data.responseText);
          console.log(data);
          var errorContent = "";
          if(res && res.errors){
            
            $.each(res.errors, function(key, value){
              errorContent += "<div>" + key + " " + value + "</div>";
            });
          }
          $(".errors").html(errorContent);
        },
        500: function(data){
          console.log(data);
        }
      },
      dataType: "json"
    });
  });

})(jQuery);
</script>

